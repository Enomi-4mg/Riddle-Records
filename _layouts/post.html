---
layout: default
---

<style>
  /* æ—¥ä»˜è¡¨ç¤ºã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .post-date { 
    display: inline-block;
  }
  
  /* æ­Œè©ã‚’é–‹ã„ãŸã¨ãã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  .post-lyrics details[open] pre {
    animation: contentFadeIn 0.5s ease-out forwards;
  }
  
  @keyframes contentFadeIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<article class="post">
    <h1 class="page_title">{{ page.title }}</h1>
    
    {% if page.date %}
    <time datetime="{{ page.date | date: '%Y-%m-%d' }}" class="post-date">
        {{ page.date | date: "%Yå¹´%mæœˆ%dæ—¥" }}
    </time>
    {% endif %}
    
    {{ content }}
    
    {% if page.use_math %}
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
    </script>
    {% endif %}
    
    {% if page.credits or page.description %}
    <section class="post-info">
        {% if page.credits %}
        <div class="post-credits">
            <h3>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</h3>
            <pre>{{ page.credits }}</pre>
        </div>
        {% endif %}
        
        {% if page.description %}
        <div class="post-description">
            <h3>è©³ç´°æƒ…å ±</h3>
            <p>{{ page.description }}</p>
        </div>
        {% endif %}
    </section>
    {% endif %}
    
    {% if page.lyrics %}
    <section class="post-lyrics">
        <details id="lyrics-details">
            <summary>æ­Œè©</summary>
            <pre>{{ page.lyrics }}</pre>
        </details>
    </section>
    {% endif %}
    
    {% if page.date %}
    <!-- é–¢é€£ä½œå“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="post-related">
        <h2>ğŸ”— é–¢é€£ä½œå“</h2>
        
        <!-- æ‰‹å‹•æŒ‡å®šã®é–¢é€£ä½œå“ (featured_related) -->
        {% if page.featured_related and page.featured_related.size > 0 %}
        <div class="featured-works" data-section-type="featured">
            <h3>ğŸ“Œ ãŠã™ã™ã‚</h3>
            <div class="related-grid">
                {% for cloudinary_id in page.featured_related %}
                    {% assign item = site.data.gallery | where: "cloudinary_id", cloudinary_id | first %}
                    {% if item %}
                    <a href="{% if item.article_url %}{{ item.article_url | relative_url }}{% else %}{{ site.baseurl }}/gallery#{{ item.cloudinary_id | slugify }}{% endif %}" class="related-item">
                        <img src="{{ site.cloudinary_url }}/w_200,h_200,c_fill,q_auto,f_auto/v1/{{ item.cloudinary_id }}" 
                             alt="{{ item.title }}"
                             loading="lazy">
                        <p>{{ item.title }}</p>
                    </a>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- è¨˜äº‹å†…ã«ç™»å ´ã—ãŸä½œå“ï¼ˆè‡ªå‹•æ¤œå‡ºï¼‰ -->
        <div id="content-related-works" data-section-type="content" style="display: none;">
            <h3>ğŸ“¸ è¨˜äº‹å†…ã§ç™»å ´</h3>
            <div class="related-grid" id="content-works-grid"></div>
        </div>

        <!-- è‡ªå‹•æŠ½å‡º: åŒã˜æ—¥ä»˜ã®ä½œå“ -->
        {% assign same_date_works = site.data.gallery | where: "date", page.date | sort: "title" %}
        {% if same_date_works.size > 0 %}
        <div class="auto-related-works" data-section-type="same-date">
            <h3>ğŸ“… åŒã˜æ—¥ã®ä½œå“</h3>
            <div class="related-grid">
                {% for item in same_date_works %}
                <a href="{{ site.baseurl }}/gallery#{{ item.cloudinary_id | slugify }}" class="related-item">
                    <img src="{{ site.cloudinary_url }}/w_200,h_200,c_fill,q_auto,f_auto/v1/{{ item.cloudinary_id }}" 
                         alt="{{ item.title }}"
                         loading="lazy">
                    <p>{{ item.title }}</p>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- é–¢é€£ä½œå“ãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆJavaScript ã§åˆ¶å¾¡ï¼‰ -->
        <div id="no-related-message" style="display: none;">
            <p class="no-related-text">ã“ã®è¨˜äº‹ã«é–¢é€£ã™ã‚‹ä½œå“ã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
        </div>
    </section>

    <!-- é–¢é€£è¨˜äº‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    {% assign related_articles = "" %}
    {% if page.tags and page.tags.size > 0 %}
        {% for tag in page.tags %}
            {% for post in site.journal %}
                {% if post.url != page.url and post.tags %}
                    {% for post_tag in post.tags %}
                        {% if post_tag == tag and related_articles != post.url %}
                            {% assign related_articles = related_articles | append: post.url | append: "," %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}
        {% endfor %}
        {% assign related_urls = related_articles | split: "," | uniq %}
        {% if related_urls.size > 0 %}
        <section class="post-related-articles">
            <h2>ğŸ“– é–¢é€£è¨˜äº‹</h2>
            <ul>
                {% for url in related_urls %}
                    {% if url != "" %}
                        {% assign found_post = site.journal | where: "url", url | first %}
                        {% if found_post %}
                        <li><a href="{{ found_post.url | relative_url }}">{{ found_post.title }}</a></li>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </ul>
        </section>
        {% endif %}
    {% endif %}
    {% endif %}
    
    <nav class="post-nav" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #ccc;">
        {% if page.previous %}
        <a href="{{ page.previous.url | relative_url }}" style="margin-right: 1rem;">â† {{ page.previous.title }}</a>
        {% endif %}
        
        {% if page.next %}
        <a href="{{ page.next.url | relative_url }}">{{ page.next.title }} â†’</a>
        {% endif %}
    </nav>
</article>

<style>
.responsive-video-container {
    position: relative;
    width: 100%;
    max-width: 900px;
    margin: 2rem auto;
    padding-bottom: 56.25%;
    height: 0;
    overflow: hidden;
    background-color: #000;
}

.responsive-video-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
}
</style>

<!-- ç”»åƒè‡ªå‹•æ¤œå‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆ: è¨˜äº‹å†…ã® Cloudinary ç”»åƒã«ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
{% unless page.hide_gallery_buttons %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    if (typeof window.galleryData === 'undefined') {
      console.warn('Gallery data not loaded');
      return;
    }
    
    // è¨˜äº‹å†…ã§ä½¿ç”¨ã•ã‚ŒãŸä½œå“ã‚’åé›†
    const contentWorksSet = new Set();
    const images = document.querySelectorAll('article.post img');
    
    images.forEach(img => {
      // ç”»åƒã¾ãŸã¯è¦ªè¦ç´ ã« no-gallery-button ã‚¯ãƒ©ã‚¹ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      if (img.classList.contains('no-gallery-button') || 
          img.closest('.no-gallery-button')) {
        return;
      }
      
      const src = img.src;
      
      // Cloudinary URL ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆcloudinary_idï¼‰ã‚’æŠ½å‡º
      // ä¾‹: https://res.cloudinary.com/.../v1/five_apples_spot_angle2_pint_mgaggo.png
      const match = src.match(/\/v1\/([^?]+)/);
      
      if (match) {
        const cloudinaryId = match[1];
        
        // gallery.yml ã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è©²å½“ã™ã‚‹ä½œå“ã‚’æ¤œç´¢
        const galleryItem = window.galleryData.find(
          item => item.cloudinary_id === cloudinaryId
        );
        
        if (galleryItem) {
          contentWorksSet.add(cloudinaryId);
          
          // ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
          const btn = document.createElement('a');
          btn.href = '{{ site.baseurl }}/gallery#' + cloudinaryId.replace(/\./g, '-');
          btn.className = 'gallery-link-btn';
          btn.innerHTML = 'ğŸ“¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã§è¦‹ã‚‹';
          
          // ç”»åƒã®è¦ªè¦ç´ ï¼ˆp ã‚¿ã‚°ãªã©ï¼‰ã®ç›´å¾Œã«æŒ¿å…¥
          const parent = img.parentNode;
          if (parent) {
            parent.insertAdjacentElement('afterend', btn);
          }
        }
      }
    });

    // è¨˜äº‹å†…ã«ç™»å ´ã—ãŸä½œå“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
    if (contentWorksSet.size > 0) {
      const contentWorksDiv = document.getElementById('content-related-works');
      const grid = document.getElementById('content-works-grid');
      
      contentWorksSet.forEach(cloudinaryId => {
        const item = window.galleryData.find(
          g => g.cloudinary_id === cloudinaryId
        );
        
        if (item) {
          const link = document.createElement('a');
          link.href = '{{ site.baseurl }}/gallery#' + cloudinaryId.replace(/\./g, '-');
          link.className = 'related-item';
          link.innerHTML = `
            <img src="{{ site.cloudinary_url }}/w_200,h_200,c_fill,q_auto,f_auto/v1/${cloudinaryId}" 
                 alt="${item.title || 'ä½œå“'}"
                 loading="lazy">
            <p>${item.title || cloudinaryId}</p>
          `;
          grid.appendChild(link);
        }
      });
      
      if (grid.children.length > 0) {
        contentWorksDiv.style.display = 'block';
      }
    }
    
    // é–¢é€£ä½œå“ãƒã‚§ãƒƒã‚¯é–¢æ•°ã‚’å‘¼ã³å‡ºã—ï¼ˆgallery.jsã§å®šç¾©ï¼‰
    if (typeof window.checkRelatedWorks === 'function') {
      window.checkRelatedWorks();
    }
  });
</script>
{% endunless %}

<!-- Lightboxè‡ªå‹•é©ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: Journalç”»åƒã«data-lightboxå±æ€§ã‚’ä»˜ä¸ -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // .post-content å†…ã®å…¨ã¦ã® img ã‚¿ã‚°ã‚’å–å¾—
    const postContent = document.querySelector('.post-content');
    if (!postContent) return;
    
    const images = postContent.querySelectorAll('img');
    
    images.forEach(img => {
      // æ—¢ã« <a> ã‚¿ã‚°ã§å›²ã¾ã‚Œã¦ã„ãªã„ ã‹ã¤ã€data-lightboxå±æ€§ãŒãªã„ç”»åƒã®ã¿å‡¦ç†
      if (img.parentNode.tagName !== 'A' && !img.hasAttribute('data-lightbox')) {
        // ç”»åƒã‚’ <a> ã‚¿ã‚°ã§å›²ã‚€
        const link = document.createElement('a');
        link.href = img.src;
        link.setAttribute('data-lightbox', 'diary');
        link.setAttribute('data-title', img.alt || '');
        
        // ç”»åƒã®è¦ªè¦ç´ ã«æŒ¿å…¥
        img.parentNode.insertBefore(link, img);
        link.appendChild(img);
      }
    });
    
    // Lyrics details animation reset
    const lyricsDetails = document.getElementById('lyrics-details');
    if (lyricsDetails) {
      lyricsDetails.addEventListener('toggle', function() {
        if (this.open) {
          const pre = this.querySelector('pre');
          if (pre) {
            // Force animation restart
            pre.style.animation = 'none';
            // Trigger reflow to restart animation
            void pre.offsetWidth;
            pre.style.animation = 'contentFadeIn 0.5s ease-out forwards';
          }
        }
      });
    }
  });
</script>
