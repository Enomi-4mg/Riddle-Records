---
render_with_liquid: false
---
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»åƒåœ§ç¸®ãƒ„ãƒ¼ãƒ« - ImageMagick WASM</title>
    <link rel="stylesheet" href="tools.css">
    <link rel="stylesheet" href="image-compressor.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ–¼ï¸ ç”»åƒåœ§ç¸®ãƒ„ãƒ¼ãƒ«</h1>
        <p class="info">ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ç”»åƒã‚’åœ§ç¸®ï¼ˆImageMagick WASMä½¿ç”¨ï¼‰<br>å¯¾å¿œå½¢å¼: JPEG, PNG, GIF, BMP, TIFF â€»WebPã¯ç¾åœ¨æœªå¯¾å¿œ</p>
        
        <div class="file-input-area" id="dropZone">
            <p style="margin: 0; font-size: 1.2rem; font-weight: bold;">ğŸ“ ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠ</p>
            <p style="margin: 10px 0 0 0; color: #999; font-size: 0.9rem;">
                ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ï¼ˆè¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œï¼‰
            </p>
        </div>
        <input type="file" id="fileInput" accept="image/*" multiple>
        
        <!-- é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ -->
        <div id="fileListArea" class="file-list-area" style="display:none;">
            <h4>é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ« (<span id="fileCount">0</span>ä»¶)</h4>
            <div id="fileList" class="file-list"></div>
        </div>
        
        <div class="format-selector">
            <button class="format-btn active" data-format="jpeg" onclick="selectFormat('jpeg')">
                ğŸ“¸ JPEG
            </button>
            <button class="format-btn" data-format="png" onclick="selectFormat('png')">
                ğŸ¨ PNG
            </button>
            <button class="format-btn disabled" data-format="webp" title="WebPã¯ç¾åœ¨æœªå¯¾å¿œã§ã™">
                ğŸš« WebP (æœªå¯¾å¿œ)
            </button>
        </div>
        
        <div class="quality-control">
            <label for="qualitySlider">åœ§ç¸®å“è³ª: <span id="qualityValue">85</span></label>
            <input type="range" id="qualitySlider" min="10" max="100" value="85" step="5">
            <div class="quality-presets">
                <button onclick="setPreset('low')">ä½ (60)</button>
                <button onclick="setPreset('medium')">ä¸­ (75)</button>
                <button onclick="setPreset('high')">é«˜ (85)</button>
                <button onclick="setPreset('maximum')">æœ€é«˜ (95)</button>
            </div>
        </div>
        
        <!-- JPEGè©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
        <div id="jpegOptions" class="format-options">
            <h4>JPEG ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h4>
            <label>
                <input type="checkbox" id="progressive" checked>
                ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–JPEGï¼ˆæ®µéšçš„ã«è¡¨ç¤ºï¼‰
            </label>
            <label>
                <input type="checkbox" id="stripMetadata" checked>
                ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºå‰Šæ¸›ï¼‰
            </label>
        </div>
        
        <!-- PNGè©³ç´°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
        <div id="pngOptions" class="format-options" style="display:none;">
            <h4>PNG ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h4>
            <label>
                è‰²æ•°åˆ¶é™:
                <select id="pngColors">
                    <option value="none">åˆ¶é™ãªã—</option>
                    <option value="256">256è‰²ï¼ˆ8bitï¼‰</option>
                    <option value="128">128è‰²</option>
                    <option value="64">64è‰²</option>
                </select>
            </label>
            <label>
                <input type="checkbox" id="pngStrip" checked>
                ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            </label>
        </div>
        
        <!-- ãƒ•ã‚¡ã‚¤ãƒ«åã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
        <div class="filename-options">
            <h4>å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«å</h4>
            <div class="filename-preview">
                ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: <span id="filenamePreview">example_compressed.jpg</span>
            </div>
            <label>
                <input type="radio" name="filenameMode" value="original" checked onchange="updateFilenamePreview()">
                å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¿æŒï¼ˆä¾‹: photo.jpg â†’ photo.jpgï¼‰
            </label>
            <label>
                <input type="radio" name="filenameMode" value="timestamp" onchange="updateFilenamePreview()">
                ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ä¸
                <small>ä¾‹: photo.jpg â†’ photo_20260119_143052.jpg</small>
            </label>
            <label>
                <input type="radio" name="filenameMode" value="custom" onchange="updateFilenamePreview()">
                ã‚«ã‚¹ã‚¿ãƒ æ¥é ­è¾ãƒ»æ¥å°¾è¾
            </label>
            <div id="customFilenameInputs" style="display:none;">
                <label>
                    æ¥é ­è¾: <input type="text" id="filenamePrefix" placeholder="compressed_" oninput="updateFilenamePreview()">
                </label>
                <label>
                    æ¥å°¾è¾: <input type="text" id="filenameSuffix" placeholder="_opt" oninput="updateFilenamePreview()">
                </label>
            </div>
        </div>
        
        <button class="compress-btn" id="compressBtn" onclick="startCompression()" disabled>
            åœ§ç¸®å®Ÿè¡Œ
        </button>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div class="loading-text">ç”»åƒã‚’å‡¦ç†ä¸­...</div>
            <div class="progress-info">
                <span id="progressText">0 / 0</span>
            </div>
        </div>
        
        <div id="outputArea" class="output-area">
            <h3>ğŸ“Š åœ§ç¸®çµæœ</h3>
            <div class="summary" id="summary">
                <strong>å‡¦ç†ã‚µãƒãƒªãƒ¼</strong>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-value" id="successCount">0</div>
                        <div class="summary-stat-label">æˆåŠŸ</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value" id="failCount">0</div>
                        <div class="summary-stat-label">å¤±æ•—</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-value" id="totalReduction">0%</div>
                        <div class="summary-stat-label">å¹³å‡å‰Šæ¸›ç‡</div>
                    </div>
                </div>
            </div>
            <div class="results-list" id="resultsList"></div>
        </div>

        <footer class="tool-footer" style="margin-top:30px; color:#666; font-size:0.85rem; text-align:center;">
            ImageMagick WASM (Apache-2.0) ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚GitHub: 
            <a href="https://github.com/KnicKnic/WASM-ImageMagick" target="_blank" rel="noopener" style="color:#007acc;">KnicKnic/WASM-ImageMagick</a>
        </footer>
    </div>

    <script type="module">
        import * as Magick from 'https://knicknic.github.io/wasm-imagemagick/magickApi.js';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let selectedFiles = [];
        let currentFormat = 'jpeg';
        let currentQuality = 85;
        let processingQueue = [];
        let processedResults = [];
        const MAX_CONCURRENT = 3;

        // WebAssemblyå¯¾å¿œãƒã‚§ãƒƒã‚¯
        if (!window.WebAssembly) {
            document.body.innerHTML = '<div class="error-message" style="max-width:800px;margin:50px auto;padding:20px;"><strong>ã‚¨ãƒ©ãƒ¼</strong>ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯WebAssemblyã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã€Firefoxã€Safariã€Edgeã®æœ€æ–°ç‰ˆã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚</div>';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
        document.getElementById('fileInput').addEventListener('change', function(e) {
            handleFiles(Array.from(e.target.files));
        });

        document.getElementById('dropZone').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            if (files.length > 0) {
                handleFiles(files);
            }
        });

        function handleFiles(files) {
            selectedFiles = files;
            document.getElementById('compressBtn').disabled = false;
            updateFilenamePreview();
            displayFileList();
        }

        function displayFileList() {
            const fileListArea = document.getElementById('fileListArea');
            const fileList = document.getElementById('fileList');
            const fileCount = document.getElementById('fileCount');
            
            if (selectedFiles.length === 0) {
                fileListArea.style.display = 'none';
                return;
            }
            
            fileListArea.style.display = 'block';
            fileCount.textContent = selectedFiles.length;
            
            fileList.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-item-info">
                        <span class="file-item-icon">ğŸ–¼ï¸</span>
                        <span class="file-item-name">${file.name}</span>
                        <span class="file-item-size">${formatBytes(file.size)}</span>
                    </div>
                    <button class="file-item-remove" onclick="removeFile(${index})" title="å‰Šé™¤">Ã—</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        window.removeFile = function(index) {
            selectedFiles = Array.from(selectedFiles).filter((_, i) => i !== index);
            displayFileList();
            updateFilenamePreview();
            
            if (selectedFiles.length === 0) {
                document.getElementById('compressBtn').disabled = true;
            }
        };

        // å½¢å¼é¸æŠ
        window.selectFormat = function(format) {
            if (format === 'webp') return;
            currentFormat = format;
            
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-format="${format}"]`).classList.add('active');
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('jpegOptions').style.display = format === 'jpeg' ? 'block' : 'none';
            document.getElementById('pngOptions').style.display = format === 'png' ? 'block' : 'none';
            
            updateFilenamePreview();
        };

        // å“è³ªèª¿æ•´
        document.getElementById('qualitySlider').addEventListener('input', function(e) {
            currentQuality = parseInt(e.target.value);
            document.getElementById('qualityValue').textContent = e.target.value;
        });

        window.setPreset = function(preset) {
            const presets = { low: 60, medium: 75, high: 85, maximum: 95 };
            const quality = presets[preset];
            document.getElementById('qualitySlider').value = quality;
            currentQuality = quality;
            document.getElementById('qualityValue').textContent = quality;
        };

        // ãƒ•ã‚¡ã‚¤ãƒ«åãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        window.updateFilenamePreview = function() {
            const mode = document.querySelector('input[name="filenameMode"]:checked').value;
            const customInputs = document.getElementById('customFilenameInputs');
            customInputs.style.display = mode === 'custom' ? 'block' : 'none';
            
            if (selectedFiles.length === 0) {
                document.getElementById('filenamePreview').textContent = 'example_compressed.jpg';
                return;
            }
            
            const exampleFile = selectedFiles[0].name;
            const newName = generateFilename(exampleFile, mode);
            document.getElementById('filenamePreview').textContent = newName;
        };

        function generateFilename(originalName, mode = null) {
            if (!mode) {
                mode = document.querySelector('input[name="filenameMode"]:checked').value;
            }
            
            const nameWithoutExt = originalName.replace(/\.[^/.]+$/, '');
            const outputExt = currentFormat === 'jpeg' ? 'jpg' : currentFormat;
            
            switch(mode) {
                case 'original':
                    return `${nameWithoutExt}.${outputExt}`;
                    
                case 'timestamp':
                    const now = new Date();
                    const timestamp = now.toISOString()
                        .replace(/[-:]/g, '')
                        .replace('T', '_')
                        .split('.')[0];
                    return `${nameWithoutExt}_${timestamp}.${outputExt}`;
                    
                case 'custom':
                    const prefix = document.getElementById('filenamePrefix').value || '';
                    const suffix = document.getElementById('filenameSuffix').value || '';
                    return `${prefix}${nameWithoutExt}${suffix}.${outputExt}`;
                    
                default:
                    return `${nameWithoutExt}.${outputExt}`;
            }
        }

        // åœ§ç¸®å®Ÿè¡Œ
        window.startCompression = async function() {
            if (selectedFiles.length === 0) return;
            
            document.getElementById('compressBtn').disabled = true;
            document.getElementById('loading').classList.add('visible');
            document.getElementById('outputArea').classList.remove('visible');
            
            processedResults = [];
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';
            
            // ãƒãƒƒãƒå‡¦ç†
            await processFilesInBatches(selectedFiles);
            
            // çµæœè¡¨ç¤º
            displayResults();
            
            document.getElementById('loading').classList.remove('visible');
            document.getElementById('outputArea').classList.add('visible');
            document.getElementById('compressBtn').disabled = false;
        };

        async function processFilesInBatches(files) {
            const total = files.length;
            let processed = 0;
            
            for (let i = 0; i < files.length; i += MAX_CONCURRENT) {
                const batch = files.slice(i, i + MAX_CONCURRENT);
                const promises = batch.map(file => compressImage(file));
                const results = await Promise.allSettled(promises);
                
                results.forEach((result, index) => {
                    processed++;
                    document.getElementById('progressText').textContent = `${processed} / ${total}`;
                    
                    if (result.status === 'fulfilled') {
                        processedResults.push(result.value);
                    } else {
                        processedResults.push({
                            success: false,
                            filename: batch[index].name,
                            error: result.reason.message || 'å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ'
                        });
                    }
                });
            }
        }

        async function compressImage(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const sourceBytes = new Uint8Array(arrayBuffer);
                
                const inputExt = file.name.split('.').pop().toLowerCase();
                const outputExt = currentFormat === 'jpeg' ? 'jpg' : currentFormat;
                
                // ImageMagickã‚³ãƒãƒ³ãƒ‰æ§‹ç¯‰
                const command = buildImageMagickCommand(inputExt, outputExt);
                
                const result = await Magick.Call(
                    [{ name: `input.${inputExt}`, content: sourceBytes }],
                    command
                );
                
                if (result.length === 0) {
                    throw new Error('ç”»åƒå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const mimeType = currentFormat === 'jpeg' ? 'image/jpeg' : `image/${currentFormat}`;
                const compressedBlob = new Blob([result[0].buffer], { type: mimeType });
                
                const originalSize = file.size;
                const compressedSize = compressedBlob.size;
                const reduction = ((1 - compressedSize / originalSize) * 100).toFixed(1);
                
                return {
                    success: true,
                    filename: file.name,
                    originalBlob: file,
                    compressedBlob: compressedBlob,
                    originalSize: originalSize,
                    compressedSize: compressedSize,
                    reduction: reduction,
                    outputFilename: generateFilename(file.name)
                };
                
            } catch (error) {
                throw new Error(`${file.name}: ${error.message}`);
            }
        }

        function buildImageMagickCommand(inputExt, outputExt) {
            const command = ['convert', `input.${inputExt}`];
            
            // å“è³ªè¨­å®š
            command.push('-quality', currentQuality.toString());
            
            if (currentFormat === 'jpeg') {
                // JPEG ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                if (document.getElementById('progressive').checked) {
                    command.push('-interlace', 'Plane');
                }
                if (document.getElementById('stripMetadata').checked) {
                    command.push('-strip');
                }
            } else if (currentFormat === 'png') {
                // PNG ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                const colors = document.getElementById('pngColors').value;
                if (colors !== 'none') {
                    command.push('-colors', colors);
                }
                if (document.getElementById('pngStrip').checked) {
                    command.push('-strip');
                }
                command.push('-define', 'png:compression-level=9');
            }
            
            command.push(`output.${outputExt}`);
            return command;
        }

        function displayResults() {
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';
            
            let successCount = 0;
            let failCount = 0;
            let totalReduction = 0;
            
            processedResults.forEach((result, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = result.success ? 'result-item' : 'result-item error';
                
                if (result.success) {
                    successCount++;
                    totalReduction += parseFloat(result.reduction);
                    
                    const originalUrl = URL.createObjectURL(result.originalBlob);
                    const compressedUrl = URL.createObjectURL(result.compressedBlob);
                    
                    resultItem.innerHTML = `
                        <div class="result-header">
                            <div class="result-filename">${result.filename}</div>
                            <div class="result-status success">âœ“ æˆåŠŸ</div>
                        </div>
                        <div class="comparison">
                            <div class="image-card">
                                <h5>å…ƒç”»åƒ</h5>
                                <img src="${originalUrl}" alt="å…ƒç”»åƒ">
                                <div class="image-info">
                                    <div>ã‚µã‚¤ã‚º: <strong>${formatBytes(result.originalSize)}</strong></div>
                                </div>
                            </div>
                            <div class="image-card">
                                <h5>åœ§ç¸®å¾Œ</h5>
                                <img src="${compressedUrl}" alt="åœ§ç¸®å¾Œ">
                                <div class="image-info">
                                    <div>ã‚µã‚¤ã‚º: <strong>${formatBytes(result.compressedSize)}</strong></div>
                                    <div>å‰Šæ¸›ç‡: <span class="reduction-rate">${result.reduction}%</span></div>
                                </div>
                                <button class="download-btn" onclick="downloadImage(${index})">
                                    ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    failCount++;
                    resultItem.innerHTML = `
                        <div class="result-header">
                            <div class="result-filename">${result.filename}</div>
                            <div class="result-status error">âœ— å¤±æ•—</div>
                        </div>
                        <div class="error-message">${result.error}</div>
                    `;
                }
                
                resultsList.appendChild(resultItem);
            });
            
            // ã‚µãƒãƒªãƒ¼æ›´æ–°
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('failCount').textContent = failCount;
            document.getElementById('totalReduction').textContent = 
                successCount > 0 ? (totalReduction / successCount).toFixed(1) + '%' : '0%';
        }

        window.downloadImage = function(index) {
            const result = processedResults[index];
            if (!result.success) return;
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(result.compressedBlob);
            a.download = result.outputFilename;
            a.click();
        };

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }
    </script>
</body>
</html>
